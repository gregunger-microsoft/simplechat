# Stage 1: Build environment
FROM python:3.13-slim AS builder

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONIOENCODING=utf-8 \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# Install build deps only if needed by pip packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libffi-dev \
    libssl-dev \
    libsqlite3-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Create nonroot user
RUN groupadd -g 65532 nonroot && \
    useradd -m -u 65532 -g nonroot nonroot

# Create venv
RUN python -m venv /app/venv
ENV PATH="/app/venv/bin:$PATH"

# Install wheel + requirements
COPY application/single_app/requirements.txt /app/requirements.txt
RUN pip install --upgrade pip wheel && \
    pip install --no-cache-dir -r /app/requirements.txt

# Copy application code
COPY application/single_app/ /app/

# Fix permissions and required runtime directories
RUN mkdir -p /app/flask_session /sc-temp-files && \
    chown -R 65532:65532 /app /sc-temp-files

USER 65532:65532

# Stage 2: Final runtime image
FROM python:3.13-slim

ENV PYTHONIOENCODING=utf-8 \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    PYTHONUNBUFFERED=1 \
    PATH="/app/venv/bin:$PATH"

WORKDIR /app

# Copy venv + app from builder
COPY --from=builder --chown=65532:65532 /app /app

RUN mkdir -p /sc-temp-files && chown -R 65532:65532 /sc-temp-files

EXPOSE 5000

USER 65532:65532

ENTRYPOINT ["python", "/app/app.py"]